#!/usr/bin/env bash
dir="$(basename "$(pwd)")"
start_time=`date +%s`
script_dir="$(dirname "$0")"
cd ${script_dir}

. imports.sh "$@"

if [[ ${PROPAGATE} == 1 ]]
then
    error "Using --propagate option on this script may lead to unexpected results. "
    comment "Exiting..."
    exit 1
fi

# reassign variables for help message
OPTION_ANALYZE=1
OPTION_METRICS=1
OPTION_MULTI_TEST=1
OPTION_COVERAGE=1
OPTION_PHPUNIT=1
OPTION_ALL=1
OPTION_NO_RESTART=1

help_message

if [[ -e "VERSION" ]]
then
    ver="Version: $(<VERSION)"
else
    ver="No version file"
fi

header "Tests, coverage, analysis and metrics script"
dark "${ver}"

if [[ -e "${TITLE_FILE}" ]]
then
    title=$(<${TITLE_FILE})
else
    title="${dir}"
    title_file="$(get_realpath ${TITLE_FILE})"
    red "No title file found."
    dark "Searched for: ${title_file}"
fi

if [[ -e "${MAIN_ENV_FILE}" ]]
then
    dark "Main .env file found"
    if [[ -e "${ENV_FILE}" ]]
    then
        env_file="$(get_realpath ${ENV_FILE})"
        dark "Secondary .env file found"
    else
        yellow "Secondary .env file not found"
        green "Creating symlink to main .env file"
        ln -s ${MAIN_ENV_FILE} ${ENV_FILE}
    fi
else
    main_env_file="$(get_realpath ${MAIN_ENV_FILE})"
    yellow "Main .env file not found, using defaults"
    dark "Searched for: ${main_env_file}"
fi

dark "Setting terminal title..."
set_title "${title} - Testing..."


if [[ ${EXEC} == 0 ]]
then
    red "No-Exec selected."
fi
options_enabled

if [[ ${RESTART_CONTAINER} == 1 ]]
then
    ./restart-container.sh "$@"
fi
info "Processing..."
if [[ ${PHPUNIT} == 1 ]]
then
  comment "PHP version:"
  docker-compose -f ${DOCKER_COMPOSE_FILE} exec app php -v
  ./phpunit "$@"
fi
if [[ ${METRICS} == 1 ]]
then
  ./phpmetrics "$@"
fi
if [[ ${MULTI_TEST} == 1 ]]
then
  ./multi "$@"
fi
if [[ ${ANALYZE} == 1 ]]
then
  ./phpstan "$@"

  ./psalm "$@"
fi
if [[ -e "${TEST_REPORT_INDEX}" ]]
then
    info "Report file found: ${TEST_REPORT_INDEX}"
else
    comment "Generating report file: ${TEST_REPORT_INDEX}"
    generate_report_file
fi

if [[ ${BEAUTY} == 1 ]]
then
  ./php-cs "$@"

  ./php-cbf "$@"
fi


end_time=`date +%s`
run_time=$((end_time-start_time))
info "Executed in ${run_time}s\nBye!"
set_title "${title}"

exit 0
